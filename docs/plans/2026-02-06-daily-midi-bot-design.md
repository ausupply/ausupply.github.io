# Daily MIDI Bot — Design Doc

**Date:** 2026-02-06
**Channel:** `#midieval`

## Overview

A GitHub Actions daily cron job that generates 4 MIDI files (melody, drums, bass, chords) and posts them to the Slack channel `#midieval`. Each day, an LLM picks a world scale, chord progression, tempo, instruments, and writes a surreal description inspired by scraped news headlines. The MIDI is generated by a combination of Google's Magenta.js models (melody, drums) and programmatic music-theory code (bass, chords).

## Pipeline

```
  [Python] Scrape headlines + sample musical inspirations
                      |
                      v
  [Python] Llama 3.3 70B (HuggingFace) --> structured musical params JSON
           (scale, root, chords, tempo, instruments, temperature, description)
                      |
                      v
  [Node.js] Magenta.js + programmatic generation
           --> 4 MIDI files (melody, drums, bass, chords)
                      |
                      v
  [Python] Upload to Slack #midieval with full metadata + description
```

Python handles headline scraping, LLM calls, and Slack posting (adapted from the surreal prompt bot). Node.js handles all MIDI generation in a single script.

## LLM Prompt Generation

Reuses the surreal prompt bot's scraper and sampler. Same headline sources (Reuters, BBC, CNN, etc.), same random inspiration sampling, just a different prompt template and a music-focused `inspirations.txt`.

### Prompt Template

Tells Llama 3.3 70B to:

1. Read the scraped headlines + musical inspirations
2. Pick a scale from a curated list of 60+ world scales (provided in the prompt)
3. Pick a root note
4. Build a 4-chord progression from that scale
5. Choose a tempo (40-200 BPM)
6. Choose instruments for melody and chords (from General MIDI list, provided in prompt)
7. Set a temperature (0.5-1.5) for the ML models
8. Write a one-line surreal description inspired by the headlines

The prompt explicitly encourages variety and weirdness in scale selection.

### LLM Output Format

```json
{
  "scale": "Maqam Hijaz",
  "root": "D",
  "chords": ["Dm", "Ebmaj7", "Gm", "A7"],
  "tempo": 95,
  "temperature": 1.2,
  "melody_instrument": 73,
  "chord_instrument": 6,
  "description": "A restless Tuesday in a bureaucracy that runs on reverb"
}
```

The scale list and General MIDI instrument list are included directly in the prompt so the LLM picks from valid options only.

### Musical Inspirations

A new music-focused `inspirations.txt` with entries like:

- "lo-fi jazz elevator music"
- "industrial machinery rhythm"
- "music box in a thunderstorm"
- "gamelan orchestra on a space station"
- "baroque harpsichord played underwater"

## Scale Database (`scales.json`)

A curated collection of 60+ scales from around the world and throughout history. Each entry includes the scale name, intervals (semitones from root), and region/origin. Categories include:

- **Middle Eastern/Arabic**: Maqam Hijaz, Maqam Bayati, Maqam Saba, Maqam Nahawand, Maqam Kurd, Maqam Sikah, Maqam Rast
- **Turkish**: Hicaz, Ussak, Nihavend, Huseyni
- **Indian**: Raga Bhairav, Raga Todi, Raga Marwa, Raga Purvi, Raga Kafi, Raga Bhairavi
- **Japanese**: Hirajoshi, Miyako-bushi, In, Yo, Iwato, Kumoi
- **Indonesian**: Pelog, Slendro
- **Chinese**: Gong, Shang, Jue, Zhi, Yu
- **African**: Equidistant pentatonic, Ethiopic scales
- **Eastern European**: Hungarian minor, Hungarian major, Romanian minor, Ukrainian Dorian, Byzantine
- **Western exotic**: Whole tone, Diminished, Augmented, Prometheus, Enigmatic, Neapolitan major/minor, Double harmonic, Tritone
- **Ancient Greek**: Lydian, Phrygian, Dorian, Mixolydian (original Greek tunings)
- **Blues/jazz**: Bebop dominant, Bebop Dorian, Blues hexatonic, Altered dominant
- **Synthetic/modern**: Messiaen's modes of limited transposition, Scriabin's Mystic chord as scale

## MIDI Generation (Node.js)

A single Node.js script (`generate_midi.js`) receives the LLM's JSON params via stdin and writes 4 MIDI files to a temp directory.

### Melody — ImprovRNN

- **Model**: `chord_pitches_improv` checkpoint (5.6 MB)
- Conditioned on the LLM's chord progression — generates notes that fit the harmony
- **Post-processing**: quantize every note to the nearest pitch in the target scale
- Instrument set to the LLM's `melody_instrument` choice

### Drums — DrumsRNN

- **Model**: `drum_kit_rnn` checkpoint (11.9 MB)
- Generates a 4-bar drum pattern
- Temperature from the LLM controls how adventurous the rhythm gets
- Independent of scale/chords (drums don't have pitch)

### Bass — Programmatic

- Built from chord roots in the chosen scale
- Simple rhythmic patterns with variation (walking bass, root-fifth, syncopated — randomly chosen)
- Quantized to the scale, locked to lower octave range (MIDI 36-60)

### Chords — Programmatic

- Each chord symbol voiced as actual MIDI notes
- Voicings built from the scale intervals
- Simple rhythmic pattern (whole notes, half notes, or rhythmic comp — randomly chosen)
- Instrument set to the LLM's `chord_instrument` choice

### Output

4 MIDI files, each 4 bars long at the LLM's specified tempo. Plain MIDI — no audio rendering.

### Node.js Dependencies

- `@magenta/music` — ImprovRNN, DrumsRNN model loading + inference
- `midi-writer-js` — programmatic MIDI file writing (bass, chords)
- `@tonaljs/tonal` — chord/scale music theory helpers

## Slack Posting

### Message Format

One initial message with all metadata, followed by 4 threaded replies each containing one MIDI file:

**Main message:**
```
:musical_note: Daily MIDI -- Maqam Hijaz in D (95 BPM)
A restless Tuesday in a bureaucracy that runs on reverb

:musical_keyboard: Melody -- ImprovRNN, Flute (MIDI 73), temperature 1.2
:drum_with_drumsticks: Drums -- DrumsRNN, temperature 1.0
:guitar: Bass -- Programmatic from chord roots
:musical_score: Chords -- Dm  Ebmaj7  Gm  A7
```

**Thread:** 4 replies, each with one `.mid` file attached and its track label.

### Slack App

Uses the existing Slack app (same as drawma + surreal prompt bot). Requires adding `files:write` scope to upload MIDI files. Uses the `files_upload_v2` API.

## Project Structure

```
midi-bot/
├── bot.py                  # Main orchestrator
├── config.yaml             # Channel, model, temperature defaults
├── prompt_template.txt     # Music-focused LLM template
├── scales.json             # 60+ world scales with intervals + origins
├── instruments.json        # General MIDI instruments grouped by category
├── inspirations.txt        # Musical vibes for LLM inspiration
├── requirements.txt        # slack-sdk, huggingface_hub, pyyaml, etc.
├── package.json            # @magenta/music, midi-writer-js, @tonaljs/tonal
├── generate_midi.js        # Node.js: all MIDI generation
└── src/
    ├── generator.py        # LLM call (adapted from surreal-prompt-bot)
    ├── scraper.py          # Headline scraping (reused from surreal-prompt-bot)
    ├── sampler.py          # Inspiration sampling (reused from surreal-prompt-bot)
    ├── slack_poster.py     # Slack file upload
    └── config.py           # Config loading
```

### Code Reuse from Surreal Prompt Bot

- `scraper.py` — reused directly (symlink or shared module)
- `sampler.py` — reused directly
- `generator.py` — adapted: same LLM call structure, different prompt template
- `slack_poster.py` — adapted: `files_upload_v2` instead of `chat_postMessage`
- `config.py` — same pattern, different defaults

## GitHub Actions Workflow

**File:** `.github/workflows/daily-midi.yml`

- **Schedule:** Daily at 4pm UTC (8am PT) — offset 1 hour from the drawing prompt (3pm UTC)
- **Manual trigger:** `workflow_dispatch` for testing
- **Steps:**
  1. Checkout repo
  2. Setup Python 3.11
  3. Setup Node.js 20
  4. Cache `node_modules` + Magenta checkpoints (~30MB total)
  5. `pip install -r midi-bot/requirements.txt`
  6. `npm ci` in `midi-bot/`
  7. `python midi-bot/bot.py`

### Secrets (all already exist)

- `HF_TOKEN` — HuggingFace API for Llama 3.3 70B
- `SLACK_BOT_TOKEN` — existing Slack app

### New Slack App Scope

- `files:write` — added to the existing app

## Error Handling

- If the LLM returns invalid JSON, log and skip the day
- If Node.js MIDI generation fails, log and skip the day
- No partial posts — either all 4 files go up or none do

## Known Limitations

- **ImprovRNN was trained on Western pop/jazz** — exotic scales are enforced via post-processing quantization, so melodies will have the right notes but may not capture the authentic phrasing of a raga or maqam
- **DrumsRNN generates general drum patterns** — it won't produce genre-specific rhythms (no tabla, no djembe patterns)
- **4 bars is short** — enough for a loop/idea, not a full composition
- **LLM may favor "safe" scales** — the prompt template explicitly encourages variety and weirdness to mitigate this

## What's Deliberately NOT Included

- No web page on the site — lives in Slack only
- No archiving MIDI files in the repo — they're ephemeral
- No audio rendering — just raw MIDI files, users load in their DAWs
- No multi-bar generation beyond 4 bars
- No user interaction / requests / voting
- No history or back-catalog
